; PlatformIO Project Configuration File
;
;   Build options: build flags, source filter
;   Upload options: custom upload port, speed and extra flags
;   Library options: dependencies, extra library storages
;   Advanced options: extra scripting
;
; Please visit documentation for the other options and examples
; https://docs.platformio.org/page/projectconf.html

[env:esp32cam_serial]
platform = espressif32
board = esp32dev
framework = arduino
monitor_speed = 115200
upload_port = COM12
monitor_port = COM12
board_build.psram = disabled
board_build.partitions = partitions_4mb.csv
board_build.filesystem = littlefs
board_build.flash_encrypt = yes
extra_scripts = post:scripts/merge_bins.py

; SSL/TLS 안정성 강화 설정
build_unflags = -Os -g -ggdb -Wall -Wextra
build_flags = 
    -I include
    -DCORE_DEBUG_LEVEL=1
    -DENABLE_DEBUG
    -DENABLE_DATABASE
    -DENABLE_FIRESTORE
    -DENABLE_STORAGE
    -O2
    -DARDUINO_LOG_LEVEL=1
    -DCONFIG_ESP_SYSTEM_PANIC_PRINT_HALT=1
    -DCONFIG_ESP_OTA_SIZE_CHECK=0
    -DCONFIG_ESP_OTA_ABORT_SAVE_LIST=1
    -fno-stack-protector
    -fomit-frame-pointer
    ; SSL/TLS 설정 강화 (더 안정적인 설정)
    -DCONFIG_MBEDTLS_SSL_CIPHERSUITES=MBEDTLS_TLS_RSA_WITH_AES_128_CBC_SHA,MBEDTLS_TLS_RSA_WITH_AES_256_CBC_SHA
    -DCONFIG_MBEDTLS_SSL_RENEGOTIATION=1
    -DCONFIG_MBEDTLS_SSL_ALPN=1
    -DCONFIG_MBEDTLS_SSL_PROTO_TLS1_2=1
    -DCONFIG_MBEDTLS_SSL_PROTO_TLS1_1=1
    -DCONFIG_MBEDTLS_SSL_PROTO_TLS1=1
    -DCONFIG_MBEDTLS_SSL_SESSION_TICKETS=1
    -DCONFIG_MBEDTLS_SSL_SESSION_TICKETS_TLS1_2=1
    -DCONFIG_MBEDTLS_SSL_SESSION_TICKETS_TLS1_1=1
    -DCONFIG_MBEDTLS_SSL_SESSION_TICKETS_TLS1=1
    ; 메모리 관리 강화
    -DCONFIG_ESP32_SPIRAM_BOOT_INIT=0
    -DCONFIG_ESP32_SPIRAM_USE_MALLOC=0

lib_deps = 
	bblanchon/ArduinoJson@^7.3.1
    arduino-libraries/ArduinoHttpClient@^0.4.0
    esp32async/AsyncTCP@3.3.6
    esp32async/ESPAsyncWebServer@3.7.2

[env:esp32cam_ota]
platform = espressif32
board = esp32dev
framework = arduino
monitor_port = COM12
monitor_speed = 115200
upload_protocol = espota
upload_port = 192.168.0.8
upload_flags =
    --port=3232
    --auth=0221
board_build.psram = disabled
board_build.partitions = partitions_4mb.csv
board_build.filesystem = littlefs
board_build.flash_encrypt = yes
extra_scripts = post:scripts/merge_bins.py

; SSL/TLS 안정성 강화 설정
build_unflags = -Os -g -ggdb -Wall -Wextra
build_flags = 
    -I include
    -DCORE_DEBUG_LEVEL=1
    -DENABLE_DEBUG
    -DENABLE_DATABASE
    -DENABLE_FIRESTORE
    -DENABLE_STORAGE
    -O2
    -DARDUINO_LOG_LEVEL=1
    -DCONFIG_ESP_SYSTEM_PANIC_PRINT_HALT=1
    -DCONFIG_ESP_OTA_SIZE_CHECK=0
    -DCONFIG_ESP_OTA_ABORT_SAVE_LIST=1
    -fno-stack-protector
    -fomit-frame-pointer
    ; SSL/TLS 설정 강화 (더 안정적인 설정)
    -DCONFIG_MBEDTLS_SSL_CIPHERSUITES=MBEDTLS_TLS_RSA_WITH_AES_128_CBC_SHA,MBEDTLS_TLS_RSA_WITH_AES_256_CBC_SHA
    -DCONFIG_MBEDTLS_SSL_RENEGOTIATION=1
    -DCONFIG_MBEDTLS_SSL_ALPN=1
    -DCONFIG_MBEDTLS_SSL_PROTO_TLS1_2=1
    -DCONFIG_MBEDTLS_SSL_PROTO_TLS1_1=1
    -DCONFIG_MBEDTLS_SSL_PROTO_TLS1=1
    -DCONFIG_MBEDTLS_SSL_SESSION_TICKETS=1
    -DCONFIG_MBEDTLS_SSL_SESSION_TICKETS_TLS1_2=1
    -DCONFIG_MBEDTLS_SSL_SESSION_TICKETS_TLS1_1=1
    -DCONFIG_MBEDTLS_SSL_SESSION_TICKETS_TLS1=1
    ; 메모리 관리 강화
    -DCONFIG_ESP32_SPIRAM_BOOT_INIT=0
    -DCONFIG_ESP32_SPIRAM_USE_MALLOC=0

lib_deps = 
	bblanchon/ArduinoJson@^7.3.1
    arduino-libraries/ArduinoHttpClient@^0.4.0
    esp32async/AsyncTCP@3.3.6
    esp32async/ESPAsyncWebServer@3.7.2
